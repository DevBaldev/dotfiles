#!/bin/bash

# --------------------------------------------------------------------------
# Configuration & Variables
# --------------------------------------------------------------------------
DOTFILES_DIR="$(pwd)/configs"
LOG_FILE="install_log.txt"

# Colors for logging
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
NC="\033[0m" # No Color

# --------------------------------------------------------------------------
# Helper Functions
# --------------------------------------------------------------------------

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

err() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Error handling: Trap errors and log the line number
trap 'err "Script failed on line $LINENO"' ERR
set -e

# Keep sudo alive
sudo_refresh() {
    while true; do sudo -v; sleep 60; done &
    SUDO_PID=$!
    trap 'kill $SUDO_PID' EXIT
}

# --------------------------------------------------------------------------
# Core Logic
# --------------------------------------------------------------------------

sys_update() {
    log "Updating system and installing base-devel..."
    sudo pacman -Syu --noconfirm --needed base-devel git
}

paru_install() {
    if command -v paru &>/dev/null; then
        log "Paru is already installed."
        return
    fi

    log "Installing Paru AUR helper..."
    # Ensure rust is installed via pacman first
    sudo pacman -S --needed --noconfirm rust
    
    git clone https://aur.archlinux.org/paru.git /tmp/paru
    pushd /tmp/paru
    makepkg -si --noconfirm
    popd
    rm -rf /tmp/paru
}

detect_gpu_drivers() {
    log "Detecting GPU for driver installation..."
    gpu_pkgs=""
    
    if lspci | grep -i "nvidia" &>/dev/null; then
        log "Nvidia GPU detected."
        gpu_pkgs="nvidia-dkms nvidia-utils lib32-nvidia-utils egl-wayland"
    elif lspci | grep -i "amd" &>/dev/null; then
        log "AMD GPU detected."
        gpu_pkgs="mesa lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader"
    elif lspci | grep -i "intel" &>/dev/null; then
        log "Intel GPU detected."
        gpu_pkgs="mesa lib32-mesa vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader"
    fi

    echo "$gpu_pkgs"
}

install_pkgs() {
    log "Installing packages..."
    
    # Detect GPU drivers dynamically
    DRIVERS=$(detect_gpu_drivers)

    # Define packages in arrays for better readability
    
    FONTS=(
        noto-fonts
        noto-fonts-cjk
        noto-fonts-emoji
        noto-fonts-extra
        ttf-cascadia-code-nerd
    )

    AUDIO=(
        pipewire
        pipewire-pulse
        pipewire-jack
        pipewire-alsa
        wireplumber
        pamixer
    )

    HYPRLAND=(
        hyprland
        hyprpaper
        hyprpolkitagent
        hyprsunset
        hyprtoolkit
        xdg-user-dirs
        xdg-desktop-portal-hyprland
        xdg-desktop-portal-gtk
    )

    THEME=(
        qt5-wayland
        qt6-wayland
        nwg-look
        kvantum
        kvantum-qt5
        qt6ct
        catppuccin-gtk-theme-mocha
        tela-circle-icon-theme-dracula
        bibata-cursor-theme-bin
    )

    UTILS=(
        wofi
        uwsm
        grim
        slurp
        swappy
        cliphist
        mako
        waybar
        ghostty
        lsd
        bat
        zoxide
        ripgrep
        tealdeer
        btop
        yazi
        ffmpeg
        7zip
        jq
        poppler
        fd
        fzf
        resvg
        imagemagick
        networkmanager-openvpn
        nm-connection-editor
        iwd
        impala
        bluez
        bluez-utils
        bluetui
        wofi-emoji
    )

    DEV=(
        rust
        pyright
        python-uv
        ruff
        lua-language-server
        marksman
        harper
        stylua
        clang
        prettier
    )

    APPS=(
        imv
        mpv
        yt-dlp
        obsidian
        ani-cli
        librewolf-bin
        steam
    )

    # Combine all packages
    ALL_PKGS="${DRIVERS} ${FONTS[*]} ${AUDIO[*]} ${HYPRLAND[*]} ${THEME[*]} ${UTILS[*]} ${DEV[*]} ${APPS[*]}"

    # Install everything in one go to minimize password prompts and dependency checks
    # Use --needed to skip already installed packages
    paru -S --needed --noconfirm $ALL_PKGS
}

change_shell() {
    log "Configuring Shell..."
    # Ensure fish is in the package list or installed here
    if ! command -v fish &>/dev/null; then
        sudo pacman -S --noconfirm fish starship
    fi

    local shell_path
    shell_path="$(command -v fish)"

    if [ "$SHELL" != "$shell_path" ]; then
        log "Changing shell to Fish..."
        sudo chsh -s "$shell_path" "$USER"
    else
        log "Shell is already set to Fish."
    fi
}

link_dotfiles() {
    log "Linking Dotfiles..."
    
    if [ ! -d "$DOTFILES_DIR" ]; then
        err "Config directory not found: $DOTFILES_DIR"
        return
    fi

    # Check if GNU Stow is installed (Cleanest way to handle dotfiles)
    if command -v stow &>/dev/null; then
        log "Using GNU Stow..."
        # Assuming your structure is configs/package/.config/package
        # If your structure is flat (configs/waybar -> ~/.config/waybar):
        for dir in "$DOTFILES_DIR"/*; do
            if [ -d "$dir" ]; then
                pkg=$(basename "$dir")
                log "Stowing $pkg..."
                # Backup existing config if it's not a symlink
                target="$HOME/.config/$pkg"
                if [ -e "$target" ] && [ ! -L "$target" ]; then
                    mv "$target" "${target}.bak"
                fi
                ln -sf "$dir" "$target" 
            fi
        done
    else
        # Fallback to manual linking
        for file in "$DOTFILES_DIR"/*; do
            filename=$(basename "$file")
            target="$HOME/.config/$filename"
            
            # Create backup if file exists and is not a symlink
            if [ -e "$target" ] && [ ! -L "$target" ]; then
                warn "Backing up existing $target to $target.backup"
                mv "$target" "$target.backup"
            fi

            log "Linking $filename"
            ln -sf "$file" "$target"
        done
    fi
}

app_setup() {
    log "Enabling Services..."
    
    # System services
    sudo systemctl enable --now bluetooth.service
    
    # User services (use || true so script doesn't fail if already enabled)
    systemctl --user enable --now mako.service || true
    systemctl --user enable --now waybar.service || true
    systemctl --user enable --now hyprpaper.service || true
    systemctl --user enable --now hyprsunset.service || true
    systemctl --user enable --now hyprpolkitagent.service || true
    
    # Network Manager setup
    if [ ! -f /etc/NetworkManager/conf.d/iwd.conf ]; then
        log "Configuring NetworkManager backend..."
        sudo mkdir -p /etc/NetworkManager/conf.d
        echo -e "[device]\nwifi.backend=iwd" | sudo tee /etc/NetworkManager/conf.d/iwd.conf
        sudo systemctl restart NetworkManager
    fi

    # Initialize tldr
    log "Updating tldr cache..."
    tldr -u || warn "Failed to update tldr cache (network issue?)"
}

# --------------------------------------------------------------------------
# Main Execution
# --------------------------------------------------------------------------

main() {
    # Ask for sudo upfront
    log "Requesting Sudo privileges..."
    sudo -v
    sudo_refresh

    sys_update
    paru_install
    install_pkgs
    link_dotfiles
    change_shell
    app_setup
    
    log "Installation Complete! Please reboot."
}

main
