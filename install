#!/bin/bash

set -e # Exit immediately if a command exits with a non-zero status

sys_update() {
  sudo pacman -Syu --noconfirm
}

paru_install() {
  if ! command -v paru &>/dev/null; then
    sudo pacman -S --needed --noconfirm base-devel git rust
    tmpdir = "$(mktemp -d)"
    git clone https://aur.archlinux.org/paru.git "$temdir/paru"
    (cd "$tmpdir/paru" && makepkg -si --noconfirm --needed)
    rm -rf "$temdir"
  fi
}

install_pkgs() {
  paru -S --needed --noconfirm "$@"
}

change_shell() {
  install_pkgs fish starship
  fish_path="$(command -v fish || true)"
  if [ -n "$fish_path" ] && [ "$SHELL" != "$fish_path" ]; then
    chsh -s "$fish_path" || echo "chsh failed; change your shell manually."
  fi
}

link_dotfiles() {
  source_dir="$(pwd)/configs"
  mkdir -p "$HOME/.config"
  for file in "$source_dir"/*; do
    [ -e "$file" ] || continue
    base="$(basename "$file")"
    target="$HOME/.config/$base"
    if [ -L "$target" ]; then
      rm -f "$target"
    elif [ -e "$target" ]; then
      mv "$target" "$target".backup."$(date +%s)"
    fi
    ln -sfn "$file" "$target"
  done
}

pkgs_install() {
  install_pkgs mesa vulkan-radeon \
    noto-fonts-{cjk,emoji,extra} ttf-cascadia-code-nerd \
    pipewire-{pulse,jack,alsa} wireplumber wiremix pamixer \
    hypr{land,paper,polkitagent,sunset,toolkit} \
    xdg-{user-dirs,desktop-portal-{hyprland,gtk}} \
    qt{5,6}-wayland nwg-look kvantum{,-qt5} qt6ct \
    wofi uwsm grim slurp swappy cliphist mako waybar \
    ghostty rust lsd bat zoxide ripgrep tealdeer btop npm unzip python-uv \
    yazi ffmpeg 7zip jq poppler fd ripgrep fzf zoxide resvg imagemagick \
    imv mpv yt-dlp obsidian mupdf \
    networkmanager-openvpn nm-connection-editor \
    blue{tui,z{,-tools}} \
    tela-circle-icon-theme-dracula || true

  install_pkgs wofi-emoji ani-cli librewolf-bin \
    catppuccin-gtk-theme-mocha bibata-cursor-theme-bin || true
}

app_setup() {
  tldr -u || echo "Failed to update tldr cache (network issue?)"
  if systemctl --user show-environment &>/dev/null; then
    systemctl --user enable --now mako.service || true
    systemctl --user enable --now waybar.service || true
    systemctl --user enable --now hyprpaper.service || true
    systemctl --user enable --now hyprsunset.service || true
    systemctl --user enable --now hyprpolkitagent.service || true
  fi
}

main() {
  sys_update
  paru_install
  change_shell
  link_dotfiles
  pkgs_install
  app_setup
}

main
