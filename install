#!/bin/bash

set -e # Exit immediately if a command exits with a non-zero status

sys_update() {
  sudo pacman -Syu --noconfirm
}

paru_install() {
  if ! command -v paru &>/dev/null; then
    sudo pacman -Sy rust --noconfirm
    git clone https://aur.archlinux.org/paru.git
    (cd paru && makepkg -si --noconfirm)
    rm -rf paru
  fi
}

install_pkgs() {
  paru -Sy --needed "$@" --noconfirm
}

change_shell() {
  install_pkgs fish starship
  chsh -s "$(which fish)"
}

link_dotfiles() {
  source_dir="$(pwd)/configs"
  for file in "$source_dir"/*; do
    target="$HOME/.config/$(basename "$file")"
    if [ ! -e "$target" ]; then
      ln -sf "$file" "$target"
    else
      echo "Warning: $target already exists. Skipping link creation."
    fi
  done
}

pkgs_install() {
  install_pkgs mesa vulkan-radeon                                                                # Drivers
  install_pkgs noto-fonts-{cjk,emoji,extra} ttf-cascadia-code-nerd                               # Fonts
  install_pkgs pipewire-{pulse,jack,alsa} wireplumber wiremix pamixer                            # Audio
  install_pkgs hypr{land,paper,polkitagent,sunset,toolkit}                                       # Hyprland
  install_pkgs xdg-{user-dirs,desktop-portal-{hyprland,gtk}}                                     # Xdg tools
  install_pkgs qt{5,6}-wayland nwg-look kvantum{,-qt5} qt6ct                                     # Theme tools
  install_pkgs wofi uwsm grim slurp swappy cliphist mako waybar                                  # Utils
  install_pkgs ghostty rust lsd bat zoxide ripgrep tealdeer btop                                 # tools
  install_pkgs pyright python-uv ruff                                                            # Python
  install_pkgs lua-language-server marksman harper                                               # LSP
  install_pkgs stylua clang prettier                                                             # Formaters
  install_pkgs yazi ffmpeg 7zip jq poppler fd ripgrep fzf zoxide resvg imagemagick               # Yazi
  install_pkgs imv mpv yt-dlp obsidian                                                           # Media
  install_pkgs network{manager-openvpn,-manager-applet}                                          # Network
  install_pkgs blue{tui,z{,-tools}}                                                              # bluetooth
  install_pkgs wofi-emoji ani-cli librewolf-bin                                                  # Aur
  install_pkgs catppuccin-gtk-theme-mocha tela-circle-icon-theme-dracula bibata-cursor-theme-bin # Themes
  install_pkgs lib32-{mesa,vulkan-{radeon,icd-loader}} steam                                     # Gaming
}

app_setup() {
  tldr -u
  sudo systemctl enable bluetooth.service
  systemctl --user enable mako.service
  systemctl --user enable waybar.service
  systemctl --user enable hyprpaper.service
  systemctl --user enable hyprsunset.service
  systemctl --user enable hyprpolkitagent.service
}

main() {
  sys_update
  paru_install
  change_shell
  link_dotfiles
  pkgs_install
  app_setup
}

main
